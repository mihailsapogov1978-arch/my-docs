#!/bin/bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ .docx

set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ

if [ $# -ne 1 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–ø—É—Ç—å_–∫_docx>"
    exit 1
fi

DOCX_FILE="$1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -f "$DOCX_FILE" ]; then
    echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $DOCX_FILE"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º –∏–º—è –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
NAME=$(basename "$DOCX_FILE" .docx)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏
OUTPUT_DIR="docs/$NAME"
INDEX_MD="$OUTPUT_DIR/index.md"

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: $NAME"

# –°–æ–∑–¥–∞—ë–º —Ü–µ–ª–µ–≤—É—é –ø–∞–ø–∫—É
mkdir -p "$OUTPUT_DIR"

# –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º DOCX ‚Üí Markdown —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º –º–µ–¥–∏–∞
pandoc "$DOCX_FILE" \
  -o "$INDEX_MD" \
  --extract-media="$OUTPUT_DIR" \
  --wrap=none

echo "‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –û—á–∏—â–∞–µ–º Markdown –æ—Ç HTML –∏ —Å—Ç–∏–ª–µ–π
echo "üßπ –û—á–∏—â–∞–µ–º index.md –æ—Ç HTML-—Ä–∞–∑–º–µ—Ç–∫–∏..."

sed -i 's/<[^>]*>//g' "$INDEX_MD"              # –£–¥–∞–ª—è–µ–º –≤—Å–µ HTML-—Ç–µ–≥–∏
sed -i 's/{[^{}]*}//g' "$INDEX_MD"              # –£–¥–∞–ª—è–µ–º {style=...}
sed -i 's/<img [^>]*src="\([^"]*\)"[^>]*>/![image](\1)/g' "$INDEX_MD"  # –ó–∞–º–µ–Ω—è–µ–º <img> –Ω–∞ ![image](...)

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Ç–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º (–µ—Å–ª–∏ Pandoc –≤—Å—Ç–∞–≤–∏–ª –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å)
sed -i "s|!\[\](docs/$NAME/media/|!\[](media/|g" "$INDEX_MD"

echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –î–æ–±–∞–≤–ª—è–µ–º –≤ mkdocs.yml (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
if ! grep -q "$NAME/index.md" mkdocs.yml; then
    echo "üîó –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ mkdocs.yml..."
    sed -i "/nav:/a \  - $NAME: $NAME/index.md" mkdocs.yml
fi

echo "üéâ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å:"
echo "   mkdocs serve --dev-addr=0.0.0.0:8000"